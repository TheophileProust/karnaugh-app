<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G√©n√©rateur de Diagrammes de Karnaugh</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f5f7;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .container {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 800px;
      width: 90%;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    p {
      margin-bottom: 1rem;
      color: #444;
    }

    input {
      padding: 0.5rem;
      width: 260px;
      margin: 0.5rem;
      font-size: 1rem;
    }

    button {
      padding: 0.5rem 1rem;
      background: #4CAF50;
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }

    button:hover {
      background: #45a049;
    }

    canvas {
      display: block;
      margin: 1rem auto 0;
      background: #fff;
      border: 2px solid #000;
      border-radius: 8px;
    }

    .back-btn {
      display: inline-block;
      margin-top: 1rem;
      text-decoration: none;
      padding: 0.5rem 1rem;
      background: #555;
      color: #fff;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .back-btn:hover {
      background: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß© G√©n√©rateur de Diagrammes de Karnaugh</h1>
    <p>Entrez une expression avec A, B, C, D, U (union), n (intersection), - (diff√©rence), ! ou '</p>
    <input type="text" id="expression" placeholder="Ex: (AUB)n(CnB)" />
    <button id="generate">G√©n√©rer</button>
    <canvas id="kmap" width="600" height="300"></canvas>
    <a href="index.html" class="back-btn">‚¨Ö Retour √† l'accueil</a>
  </div>

  <script>
    const canvas = document.getElementById("kmap");
    const ctx = canvas.getContext("2d");

    function grayCode(n) {
      if (n === 0) return [[]];
      const prev = grayCode(n - 1);
      return [
        ...prev.map(x => [0, ...x]),
        ...prev.map(x => [1, ...x.reverse()])
      ];
    }

    function detectVariables(expr) {
      const vars = new Set(expr.toUpperCase().match(/[A-D]/g));
      return Array.from(vars).sort();
    }

    function parseExpression(expr, variables) {
      if (!expr) return "";
      let e = expr.replace(/\s+/g, "").toUpperCase();
      e = e.replace(/([A-D])('|!|[\u0304\u0305\u00AF])/g, "!$1");
      e = e.replace(/U/g, "||").replace(/[Nn]/g, "&&").replace(/-/g, "&& !");
      variables.forEach(v => {
        const regex = new RegExp(`(?<![!()])${v}(?![A-Z])`, "g");
        e = e.replace(regex, `(${v})`);
      });
      e = e.replace(/!!/g, "");
      return e;
    }

    function evalExpr(expr, values, variables) {
      const jsExpr = parseExpression(expr, variables);
      return Function(...variables, `return (${jsExpr});`)(...values);
    }

    function computeMask(expr, variables) {
      const n = variables.length;
      const combinations = grayCode(n);
      return combinations.map(comb => evalExpr(expr, comb.map(Boolean), variables) ? 1 : 0);
    }

    function drawKMap(expr) {
      const variables = detectVariables(expr);
      const n = variables.length;

      if (n < 3 || n > 4) {
        alert("Seulement 3 ou 4 variables sont support√©es (A, B, C, D).");
        return;
      }

      const mask = computeMask(expr, variables);
      const size = 100;
      const cols = 2 ** Math.ceil(n/2);
      const rows = 2 ** Math.floor(n/2);

      canvas.width = cols * size + 50;
      canvas.height = rows * size + 50;

      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.font = "14px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      const positions = [];
      const gray = grayCode(n);
      gray.forEach((vals, i) => {
        const colBits = vals.slice(0, Math.ceil(n/2));
        const rowBits = vals.slice(Math.ceil(n/2));
        const x = parseInt(colBits.join(''), 2);
        const y = parseInt(rowBits.join(''), 2);
        positions.push([x,y]);
      });

      for (let i=0; i<mask.length; i++) {
        const [x,y] = positions[i];
        const px = x*size;
        const py = y*size;
        ctx.fillStyle = mask[i] ? "#8df58d" : "#fff";
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.fillRect(px, py, size, size);
        ctx.strokeRect(px, py, size, size);

        const text = variables.map((v,j) => `${v}=${gray[i][j]}`).join(' ');
        ctx.fillStyle = "#000";
        ctx.fillText(text, px + size/2, py + size/2);
      }

      ctx.fillStyle = "#222";
      ctx.font = "18px sans-serif";
      ctx.fillText(expr, canvas.width/2, canvas.height - 20);
    }

    document.getElementById("generate").addEventListener("click", () => {
      const expr = document.getElementById("expression").value.trim();
      if (!expr) return;
      try { drawKMap(expr); } catch(e) { alert(e.message); }
    });

    drawKMap("(AUB)n(CnB)");
  </script>
</body>
</html>
